# Cấu hình Home Assistant cơ bản
homeassistant:
  name: Smart Home
  latitude: 10.8231  # Tọa độ TP.HCM
  longitude: 106.6297
  elevation: 19
  unit_system: metric
  time_zone: Asia/Ho_Chi_Minh
  country: VN
  currency: VND
  
  # Tùy chỉnh giao diện
  customize:
    sensor.living_room_temperature:
      friendly_name: "Nhiệt độ phòng khách"
      icon: mdi:thermometer
    sensor.living_room_humidity:
      friendly_name: "Độ ẩm phòng khách"
      icon: mdi:water-percent
    binary_sensor.living_room_motion:
      friendly_name: "Cảm biến chuyển động"
      icon: mdi:motion-sensor
    switch.living_room_light:
      friendly_name: "Đèn phòng khách"
      icon: mdi:lightbulb

# Kích hoạt frontend
frontend:
  themes: !include themes.yaml

# Kích hoạt config flow UI
config:

# HTTP server
http:
  server_port: 8123
  
# History & Recorder
recorder:
  db_url: sqlite:////config/home-assistant_v2.db
  purge_keep_days: 7
  include:
    entities:
      - sensor.living_room_temperature
      - sensor.living_room_humidity
      - binary_sensor.living_room_motion
      - switch.living_room_light

history:
  include:
    entities:
      - sensor.living_room_temperature
      - sensor.living_room_humidity
      - binary_sensor.living_room_motion
      - switch.living_room_light

# Logbook
logbook:
  include:
    entities:
      - sensor.living_room_temperature
      - sensor.living_room_humidity
      - binary_sensor.living_room_motion
      - switch.living_room_light

# System Health
system_health:

# Sun (để dùng condition sunset/sunrise)
sun:

# Mobile app
mobile_app:

# ============================================
# MQTT BROKER CONFIGURATION
# ============================================
mqtt:
  broker: localhost  # Hoặc core-mosquitto nếu dùng Add-on
  port: 1883
  # username: homeassistant  # Bỏ comment nếu đã setup auth
  # password: !secret mqtt_password
  discovery: true
  birth_message:
    topic: 'homeassistant/status'
    payload: 'online'
  will_message:
    topic: 'homeassistant/status'
    payload: 'offline'

# ============================================
# CẢM BIẾN NHIỆT ĐỘ/ĐỘ ẨM (DHT11)
# ============================================
# MQTT Discovery được bật - ESP8266 sẽ tự động tạo entities
# Không cần khai báo manual sensor ở đây nữa  
# Entities sẽ tự động xuất hiện:
#   - sensor.smart_home_esp8266_temperature
#   - sensor.smart_home_esp8266_humidity

sensor:
  - platform: template
    sensors:
      feels_like_temperature:
        friendly_name: "Cảm giác nhiệt độ"
        unit_of_measurement: "°C"
        value_template: >
          {% set temp = states('sensor.living_room_temperature') | float %}
          {% set hum = states('sensor.living_room_humidity') | float %}
          {% if temp > 27 and hum > 70 %}
            {{ (temp + 2) | round(1) }}
          {% elif temp < 20 %}
            {{ (temp - 1) | round(1) }}
          {% else %}
            {{ temp | round(1) }}
          {% endif %}
        icon_template: mdi:temperature-celsius
        
  # Tính điểm chỉ số thoải mái (Comfort Index)
  - platform: template
    sensors:
      comfort_index:
        friendly_name: "Chỉ số thoải mái"
        value_template: >
          {% set temp = states('sensor.living_room_temperature') | float %}
          {% set hum = states('sensor.living_room_humidity') | float %}
          {% if temp >= 22 and temp <= 26 and hum >= 40 and hum <= 60 %}
            Thoải mái
          {% elif temp > 30 or hum > 70 %}
            Nóng ẩm
          {% elif temp < 18 %}
            Lạnh
          {% else %}
            Bình thường
          {% endif %}
        icon_template: >
          {% set temp = states('sensor.living_room_temperature') | float %}
          {% if temp > 30 %}
            mdi:emoticon-sad
          {% elif temp >= 22 and temp <= 26 %}
            mdi:emoticon-happy
          {% else %}
            mdi:emoticon-neutral
          {% endif %}

# ============================================
# CẢM BIẾN CHUYỂN ĐỘNG (SR501)
# ============================================
# MQTT Discovery được bật - ESP8266 sẽ tự động tạo entities
# Không cần khai báo manual binary_sensor ở đây nữa
# Entity sẽ tự động xuất hiện: binary_sensor.smart_home_esp8266_motion
binary_sensor: []

# ============================================
# CÔNG TẮC ĐÈN LED (QUA RELAY 1)
# ============================================
# MQTT Discovery được bật - ESP8266 sẽ tự động tạo entities
# Không cần khai báo manual switch ở đây nữa
# Entity sẽ tự động xuất hiện: switch.smart_home_esp8266_led
switch: []
# ============================================
# THÔNG BÁO
# ============================================
notify:
  - platform: persistent_notification
    name: system_notify

# ============================================
# AUTOMATION SCRIPTS
# ============================================
automation: !include automations.yaml

# ============================================
# SCRIPT ACTIONS
# ============================================
script: !include scripts.yaml